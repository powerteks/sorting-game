export default class{constructor(t){(this.store=t).setData("board",[]),t.setData("qtyFullBottle",12),t.setData("qtyEmptylBottle",2),t.setData("qtyParts",4),t.setData("history",[]),t.setData("countWin",this.getCountWin()),t.setData("skin",0),this.counterFullBottle=0,this.cache=[],this.getBoard()}getBoard(t=!1){var e=JSON.parse(localStorage.getItem("board"));Array.isArray(e)&&!t||(this.fillBottles(),e=JSON.stringify(this.store.board),localStorage.setItem("board",e),localStorage.setItem("startBoard",e),localStorage.setItem("skin",this.store.skin)),this.store.board=JSON.parse(localStorage.getItem("board")),this.store.startBoard=JSON.parse(localStorage.getItem("startBoard")),this.store.skin=+localStorage.getItem("skin")}fillBottles(){for(let t=0;t<this.store.qtyFullBottle;t++)this.store.board.push([]);for(let e=0;e<this.store.qtyFullBottle;e++)for(let t=0;t<this.store.qtyParts;t++)this.fillBottle(e);for(let e=this.store.qtyFullBottle;e<this.store.qtyEmptylBottle+this.store.qtyFullBottle;e++){this.store.board.push([]);for(let t=0;t<this.store.qtyParts;t++)this.store.board[e].push(0)}this.checkFullness()}checkFullness(){let e=0;for(let t=0;t<this.store.board.length;t++)this.hasFullBottle(t)&&e++;0<e&&this.fillBottles()}fillBottle(t){var e=Math.floor(Math.random()*this.store.qtyFullBottle);this.store.board[e].length<this.store.qtyParts?this.store.board[e].push(t+1):this.fillBottle(t)}moveToCache(e){var s=this.store.board[e],o=s[this.getLastZeroIndex(s)+1],r=[];this.store.history.push(JSON.parse(JSON.stringify(this.store.board)));for(let t=this.getLastZeroIndex(s)+1;t<this.store.qtyParts;t++)if(s[t]===o)this.cache.push(s[t]),this.store.board[e][t]=0,r.push(t);else if(0!==this.store.board[t])break;return 0<r.length&&r}moveToBottle(t,e){var s=[];let o=null,r=null;var l=3!==this.getLastZeroIndex(this.store.board[t])?this.getLastZeroIndex(this.store.board[t])+1:3,l=this.store.board[t][l];!this.hasFreePlaces(t)||l!==this.cache[0]&&0!==l?(r=e,this.store.history.pop()):r=t,o=this.getLastZeroIndex(this.store.board[r]);for(let t=this.cache.length-1;-1<t;t--)this.store.board[r][o]=this.cache[t],s.push(o),o--;this.cache=[];l=this.hasFullBottle(t);let a=!1;return(a=l?this.hasFullBottles():a)&&(this.store.countWin++,localStorage.setItem("countWin",this.store.countWin)),localStorage.setItem("board",JSON.stringify(this.store.board)),{bottle:r,cells:s,fullBottle:l,win:a}}getLastZeroIndex(e){for(let t=0;t<e.length;t++)if(0!==e[t])return t-1;return 3}hasFullBottle(e){return 0!==this.store.board[e][0]&&this.store.board[e].every(t=>t===this.store.board[e][0])}hasEmptyBottle(t){return this.store.board[t].every(t=>0===t)}hasFullBottles(){let e=0;for(let t=0;t<this.store.board.length;t++)this.hasFullBottle(t)&&e++;return e===this.store.qtyFullBottle}hasFreePlaces(e){for(let t=0;t<this.store.qtyParts;t++)if(0===this.store.board[e][t]&&t+1===this.cache.length)return!0;return!1}moveBack(){this.store.board=this.store.history.pop()}getCountWin(){return null!==localStorage.getItem("countWin")&&"undefined"!==localStorage.getItem("countWin")||localStorage.setItem("countWin",0),localStorage.getItem("countWin")}restart(){this.store.board=JSON.parse(localStorage.getItem("startBoard")),this.store.history=[]}reset(){this.store.board=[],this.store.history=[],this.getBoard(!0)}}